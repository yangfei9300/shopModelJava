<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.XdUseCoupons.mapper.XdUseCouponsMapper">
    
    <resultMap type="XdUseCoupons" id="XdUseCouponsResult">
        <result property="id"    column="id"    />
        <result property="cId"    column="c_id"    />
        <result property="cCode"    column="c_code"    />
        <result property="uId"    column="u_id"    />
        <result property="status"    column="status"    />
        <result property="getTime"    column="get_time"    />
        <result property="notes"    column="notes"    />
        <result property="usedOrderId"    column="used_order_id"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateTime"    column="update_time"    />
        <result property="deptId"    column="dept_id"    />
        <result property="userId"    column="user_id"    />


        <result property="params.NAME"    column="NAME"    />
        <result property="params.type"    column="type"    />
        <result property="params.money"    column="money"    />
        <result property="params.discount"    column="discount"    />
        <result property="params.minimum_amount"    column="minimum_amount"    />
        <result property="params.start_date"    column="start_date"    />
        <result property="params.end_date"    column="end_date"    />
        <result property="params.notes"    column="notes"    />

    </resultMap>

    <sql id="selectXdUseCouponsVo">
        select id, c_id, c_code, u_id, status, get_time, notes, used_order_id, create_time, update_time, dept_id, user_id
        from xd_use_coupons as xu
    </sql>

    <select id="selectXdUseCouponsList" parameterType="XdUseCoupons" resultMap="XdUseCouponsResult">
        <include refid="selectXdUseCouponsVo"/>
        <where>  
            <if test="cId != null "> and c_id = #{cId}</if>
            <if test="cCode != null  and cCode != ''"> and c_code = #{cCode}</if>
            <if test="status != null  and status != ''"> and status = #{status}</if>
            <if test="usedOrderId != null "> and used_order_id = #{usedOrderId}</if>

            <if test="deptId != null "> and dept_id = #{deptId}</if>
            <if test="userId != null "> and user_id = #{userId}</if>

            <if test="1==1 ">and 1=1</if>
        </where>
        ${params.dataScope}
    </select>
    
    <select id="selectXdUseCouponsById" parameterType="Long" resultMap="XdUseCouponsResult">
        <include refid="selectXdUseCouponsVo"/>
        where id = #{id}
    </select>

    <insert id="insertXdUseCoupons" parameterType="XdUseCoupons" useGeneratedKeys="true" keyProperty="id">
        insert into xd_use_coupons
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="cId != null">c_id,</if>
            <if test="cCode != null">c_code,</if>
            <if test="uId != null">u_id,</if>
            <if test="status != null">status,</if>
            <if test="getTime != null">get_time,</if>
            <if test="notes != null">notes,</if>
            <if test="usedOrderId != null">used_order_id,</if>
            <if test="createTime != null">create_time,</if>
            <if test="updateTime != null">update_time,</if>
            <if test="deptId != null">dept_id,</if>
            <if test="userId != null">user_id,</if>
         </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="cId != null">#{cId},</if>
            <if test="cCode != null">#{cCode},</if>
            <if test="uId != null">#{uId},</if>
            <if test="status != null">#{status},</if>
            <if test="getTime != null">#{getTime},</if>
            <if test="notes != null">#{notes},</if>
            <if test="usedOrderId != null">#{usedOrderId},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateTime != null">#{updateTime},</if>
            <if test="deptId != null">#{deptId},</if>
            <if test="userId != null">#{userId},</if>
         </trim>
    </insert>

    <update id="updateXdUseCoupons" parameterType="XdUseCoupons">
        update xd_use_coupons
        <trim prefix="SET" suffixOverrides=",">
            <if test="cId != null">c_id = #{cId},</if>
            <if test="cCode != null">c_code = #{cCode},</if>
            <if test="uId != null">u_id = #{uId},</if>
            <if test="status != null">status = #{status},</if>
            <if test="getTime != null">get_time = #{getTime},</if>
            <if test="notes != null">notes = #{notes},</if>
            <if test="usedOrderId != null">used_order_id = #{usedOrderId},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="deptId != null">dept_id = #{deptId},</if>
            <if test="userId != null">user_id = #{userId},</if>
        </trim>
        where id = #{id}
    </update>

    <delete id="deleteXdUseCouponsById" parameterType="Long">
        delete from xd_use_coupons where id = #{id}
    </delete>

    <delete id="deleteXdUseCouponsByIds" parameterType="String">
        delete from xd_use_coupons where id in 
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>


    <select id="getCouponByUid" parameterType="XdUseCoupons" resultMap="XdUseCouponsResult" >

        <if test="id==1">

            SELECT
            xuc.id,
            xuc.c_id,
            xuc.u_id,
            xuc.STATUS,
            xc.NAME,
            xc.type,
            xc.money,
            xc.discount,
            xc.minimum_amount,
            xc.start_date,
            xc.end_date,
            xc.notes,
            xc.create_time
            FROM
            xd_use_coupons xuc
            LEFT JOIN xd_coupons xc ON xuc.c_id = xc.id
            WHERE
            xuc.c_id = xc.id
            AND    NOW() BETWEEN xc.start_date AND xc.end_date
            AND xuc.u_id =#{uId} AND xuc.`status`=1 and xuc.dept_id=#{deptId}


        </if>
        <if test="id==2">
            SELECT
            xuc.id,
            xuc.c_id,
            xuc.u_id,
            xuc.STATUS,
            xc.NAME,
            xc.type,
            xc.money,
            xc.discount,
            xc.minimum_amount,
            xc.start_date,
            xc.end_date,
            xc.notes,
            xc.create_time
            FROM
            xd_use_coupons xuc
            LEFT JOIN xd_coupons xc ON xuc.c_id = xc.id
            WHERE
            xuc.c_id = xc.id

            AND xuc.u_id =#{uId} AND xuc.`status`=2 AND xuc.dept_id=#{deptId}
        </if>
        <if test="id==3">
            SELECT
            xuc.id,
            xuc.c_id,
            xuc.u_id,
            xuc.STATUS,
            xc.NAME,
            xc.type,
            xc.money,
            xc.discount,
            xc.minimum_amount,
            xc.start_date,
            xc.end_date,
            xc.notes,
            xc.create_time
            FROM
            xd_use_coupons xuc
            LEFT JOIN xd_coupons xc ON xuc.c_id = xc.id
            WHERE
            xuc.c_id = xc.id
            AND    NOW() >  xc.end_date
            AND xuc.u_id =#{uId} AND xuc.`status`=1 AND xuc.dept_id=#{deptId}
        </if>


    </select>

</mapper>